# Docker Compose override for testing
# Uses separate network and containers to avoid affecting running instances
# Run from project root: docker compose -f nodejs/docker-compose.test.yml up --build --abort-on-container-exit

services:
  # Test database (separate from development)
  postgres-test:
    image: postgres:16-alpine
    container_name: clawdeck-postgres-test
    environment:
      POSTGRES_USER: clawdeck_test
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: clawdeck_test
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - '15433:5432' # Different port from dev postgres
    networks:
      - clawdeck-test-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready', '-U', 'clawdeck_test']
      interval: 5s
      timeout: 3s
      retries: 5

  # Test API runner (runs tests and exits)
  api-test:
    build:
      context: ..
      dockerfile: nodejs/Dockerfile
    container_name: clawdeck-api-test
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://clawdeck_test:test_password@postgres-test:5432/clawdeck_test
      JWT_SECRET: test-secret-for-testing-only
      PORT: 3000
    depends_on:
      postgres-test:
        condition: service_healthy
    networks:
      - clawdeck-test-network
    entrypoint: ['sh', '-c']
    command:
      - |
        cd /app/nodejs &&
        npx prisma generate &&
        npx prisma db push --accept-data-loss &&
        npx tsx src/server.ts &
        SERVER_PID=$$!
        echo "Waiting for API server to start..." &&
        until wget -q -T 2 -t 1 -O /dev/null http://127.0.0.1:3000/up 2>/dev/null; do sleep 1; done &&
        echo "API server is ready, running tests..." &&
        FAIL=0;
        for f in tests/integration/workflows.test.js tests/integration/tasks.test.js tests/integration/boards.test.js tests/integration/settings.test.js tests/integration/auth.test.js tests/integration/archives.test.js tests/unit/archiveScheduler.test.js; do
          echo "--- Running $$f ---";
          node --import tsx/esm --test "$$f" || FAIL=1;
        done;
        kill $$SERVER_PID 2>/dev/null;
        exit $$FAIL

  # E2E test runner
  e2e-test:
    build:
      context: ..
      dockerfile: nodejs/Dockerfile
    container_name: clawdeck-e2e-test
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://clawdeck_test:test_password@postgres-test:5432/clawdeck_test
      JWT_SECRET: test-secret-for-testing-only
      PORT: 3000
      TEST_BASE_URL: http://api-test:3000
      AUTO_MIGRATE: 'false' # Skip migrations, api-test already handles them
    depends_on:
      postgres-test:
        condition: service_healthy
      api-test:
        condition: service_started
    networks:
      - clawdeck-test-network
    entrypoint: ['sh', '-c']
    command: ['cd /app/nodejs && yarn test:e2e']

  # Archive E2E test runner
  e2e-archive-test:
    build:
      context: ..
      dockerfile: nodejs/Dockerfile
    container_name: clawdeck-e2e-archive-test
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://clawdeck_test:test_password@postgres-test:5432/clawdeck_test
      JWT_SECRET: test-secret-for-testing-only
      PORT: 3000
      TEST_BASE_URL: http://api-test:3000
    depends_on:
      postgres-test:
        condition: service_healthy
      api-test:
        condition: service_started
    networks:
      - clawdeck-test-network
    entrypoint: ['sh', '-c']
    command: ['cd /app/nodejs && npx prisma generate && node --test tests/e2e/archive-e2e.test.js']

networks:
  clawdeck-test-network:
    driver: bridge
    name: clawdeck-test-network
